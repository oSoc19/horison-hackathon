mapboxgl.accessToken =
'pk.eyJ1IjoidGltdXRhYmxlIiwiYSI6ImNqeG45MXp1YzAwN3kzbXBnZnlhaGNndXQifQ.ZpWwVyzwLHNM6dQxdJAx1g';

const userPosition = [4.352440, 50.846480];
const map = new mapboxgl.Map({
    //pitchWithRotate: true,
    //pitch: 60,
    container: 'map', // container id
    style: 'mapbox://styles/mapbox/light-v10', // stylesheet location
    center: userPosition, // starting position [lng, lat]
    zoom: 15 // starting zoom
});


const colorSchemes = {
    mono: [
        [0, 'lime'],
        [600, 'green'],
        [1200, 'blue'],
        [1800, 'purple']
    ],
    rainbow: [
        [0, 'red'],
        [400, 'orange'],
        [800, 'yellow'],
        [1200, 'green'],
        [1600, 'blue'],
        [2000, 'indigo'],
        [2400, 'violet'],
    ],
    altColor: [
        [150, '#f54e5e'],
        [900, '#f9886c'],
        [1500, '#f1f075'],
        [2100, '#56b881'],
        [2700, '#3887be'],
        [3450, '#4a4a8b']
    ],
    pendleton: [
        [150, '#eae49a'],
        [300, '#e3ce4f'],
        [600, '#eeab50'],
        [900, '#ec8353'],
        [1200, '#c88e9c'],
        [1500, '#b0517d'],
        [1800, '#375b97']
    ]
};

// TODO : improve marker positioning
function buildMarker() {
    var el = document.createElement('img');
    el.setAttribute('src', 'https://i.imgur.com/MK4NUzI.png');
    return el;
}

const options = {
    token: 'pk.eyJ1IjoiaHVudGVyb2kiLCJhIjoiY2p4bGtuMGZnMDZuNTNvcGk1NXI5aWdobSJ9.Fezd8AOzLyPZkWkRkQoYQg',
    threshold: 420,
    mode: 'walking',
    direction: 'divergent',
    resolution: 5
};

// build and display the user marker on the map
const markerElement = buildMarker();
const userMarker = new mapboxgl.Marker(markerElement).setLngLat(userPosition).addTo(map);

const size = 75;

const pulsingDot = {
    width: size,
    height: size,
    data: new Uint8Array(size * size * 4),
    onAdd: function() {
        const canvas = document.createElement('canvas');
        canvas.width = this.width;
        canvas.height = this.height;
        this.context = canvas.getContext('2d');
    },
    render: function() {
        var duration = 1000;
        var t = (performance.now() % duration) / duration;
        var radius = size / 2 * 0.3;
        var outerRadius = size / 2 * 0.7 * t + radius;
        var context = this.context;

        // draw outer circle
        context.clearRect(0, 0, this.width, this.height);
        context.beginPath();
        context.arc(this.width / 2, this.height / 2, outerRadius, 0, Math.PI * 2);
        context.fillStyle = 'rgba(255, 200, 200,' + (1 - t) + ')';
        context.fill();

        // draw inner circle
        context.beginPath();
        context.arc(this.width / 2, this.height / 2, radius, 0, Math.PI * 2);
        context.fillStyle = 'rgba(255, 100, 100, 1)';
        context.strokeStyle = 'white';
        context.lineWidth = 2 + 4 * (1 - t);
        context.fill();
        context.stroke();

        // update this image's data with data from the canvas
        this.data = context.getImageData(0, 0, this.width, this.height).data;

        // keep the map repainting
        map.triggerRepaint();

        // return `true` to let the map know that the image was updated
        return true;
    }
};

const rawData = {
    "type":"FeatureCollection",
    "features":[
        {
            "properties":{
                "time": 60
            },
            "type":"Feature",
            "geometry":{
                "type": "Polygon",
                "coordinates":[
                    [
                        [
                            50.84782905217479,
                            4.347819637392174
                        ],
                        [
                            50.848997720089095,
                            4.349189875159761
                        ],
                        [
                            50.84913574793822,
                            4.350060333079033
                        ],
                        [
                            50.849246222979815,
                            4.350825890342838
                        ],
                        [
                            50.84944275037694,
                            4.352761662432139
                        ],
                        [
                            50.84945336247095,
                            4.352907334658213
                        ],
                        [
                            50.84921054477823,
                            4.354458151696198
                        ],
                        [
                            50.84919683804159,
                            4.354516681220194
                        ],
                        [
                            50.84872509631757,
                            4.356297399647845
                        ],
                        [
                            50.848718630205056,
                            4.356313479077927
                        ],
                        [
                            50.84797678686095,
                            4.357398320660282
                        ],
                        [
                            50.84777522538478,
                            4.357507000971053
                        ],
                        [
                            50.84767933989446,
                            4.357533566523195
                        ],
                        [
                            50.84752945755167,
                            4.357546907141798
                        ],
                        [
                            50.84640556112714,
                            4.357591557252174
                        ],
                        [
                            50.84525184759866,
                            4.357045733788022
                        ],
                        [
                            50.84520750247388,
                            4.357014781982776
                        ],
                        [
                            50.84477809197598,
                            4.356648182559051
                        ],
                        [
                            50.84357983625293,
                            4.354339964843542
                        ],
                        [
                            50.84336556595746,
                            4.352476936463935
                        ],
                        [
                            50.84360897014205,
                            4.348857167784605
                        ],
                        [
                            50.84462639932587,
                            4.348161187161198
                        ],
                        [
                            50.84504877453866,
                            4.347911625645977
                        ],
                        [
                            50.84506167918195,
                            4.347908373840762
                        ],
                        [
                            50.846754379071555,
                            4.347569564492604
                        ]
                    ]
                ]
            }
        },
        {
            "properties":{
                "time": 120
            },
            "type":"Feature",
            "geometry":{
                "type": "Polygon",
                "coordinates":[
                    [
                        [
                            50.850630918381505,
                            4.361342753072012
                        ],
                        [
                            50.84901270229887,
                            4.362551073920729
                        ],
                        [
                            50.84770910772883,
                            4.362971584204033
                        ],
                        [
                            50.84519151149169,
                            4.362781493101213
                        ],
                        [
                            50.84391124361943,
                            4.361589997429265
                        ],
                        [
                            50.84242431693228,
                            4.360129829257325
                        ],
                        [
                            50.841920286268966,
                            4.359300168239768
                        ],
                        [
                            50.840700521990435,
                            4.357177482161695
                        ],
                        [
                            50.84070021944198,
                            4.357176030972435
                        ],
                        [
                            50.84034278719557,
                            4.355122708846358
                        ],
                        [
                            50.84017801283757,
                            4.353519102879441
                        ],
                        [
                            50.84007441491672,
                            4.351357478513324
                        ],
                        [
                            50.84031685458847,
                            4.346671737827487
                        ],
                        [
                            50.84087951558796,
                            4.345672749576588
                        ],
                        [
                            50.84181789249824,
                            4.3444327694831095
                        ],
                        [
                            50.8448537102936,
                            4.342675016289645
                        ],
                        [
                            50.8459445341984,
                            4.342409524183134
                        ],
                        [
                            50.84770339591709,
                            4.342519271663642
                        ],
                        [
                            50.847807312998924,
                            4.342561013613791
                        ],
                        [
                            50.84834265054773,
                            4.342789512141969
                        ],
                        [
                            50.85074083527681,
                            4.344748920738423
                        ],
                        [
                            50.851554324884546,
                            4.345416353187171
                        ],
                        [
                            50.85209704987376,
                            4.346161728946531
                        ],
                        [
                            50.8523662529914,
                            4.351112381302869
                        ],
                        [
                            50.85257230098486,
                            4.35567939696521
                        ],
                        [
                            50.85234471909662,
                            4.357312516311466
                        ],
                        [
                            50.851741544449226,
                            4.359333750501147
                        ],
                        [
                            50.85070755254601,
                            4.361208002668896
                        ]
                    ]
                ]
            }
        },
        {
            "properties":{
                "time": 180
            },
            "type":"Feature",
            "geometry":{
                "type": "Polygon",
                "coordinates":[
                    [
                        [
                            50.849500241728336,
                            4.337674726818651
                        ],
                        [
                            50.84951739707205,
                            4.3376524596932144
                        ],
                        [
                            50.84954196663477,
                            4.337693593644881
                        ],
                        [
                            50.84954475429217,
                            4.337701889484138
                        ],
                        [
                            50.849534297638556,
                            4.337719228204576
                        ],
                        [
                            50.849533076915236,
                            4.337721245965781
                        ]
                    ]
                ]
            }
        },
        {
            "properties":{
                "time": 240
            },
            "type":"Feature",
            "geometry":{
                "type": "Polygon",
                "coordinates":[
                    [
                        [
                            50.84319709953408,
                            4.3669183073901765
                        ],
                        [
                            50.84279324769381,
                            4.366970800133497
                        ],
                        [
                            50.84272419217112,
                            4.366836610689722
                        ],
                        [
                            50.842715421953415,
                            4.366671853816124
                        ],
                        [
                            50.84287997372566,
                            4.366529400322798
                        ]
                    ]
                ]
            }
        },
        {
            "properties":{
                "time": 300
            },
            "type":"Feature",
            "geometry":{
                "type": "Polygon",
                "coordinates":[
                    [
                        [
                            50.83820344127281,
                            4.341611947233967
                        ],
                        [
                            50.83820782137763,
                            4.341600933945154
                        ],
                        [
                            50.83916057005328,
                            4.340571791250457
                        ],
                        [
                            50.84287412362462,
                            4.338100626401997
                        ],
                        [
                            50.8443295,
                            4.3371353
                        ],
                        [
                            50.84435921129687,
                            4.337126610984771
                        ],
                        [
                            50.84691680482579,
                            4.337314014969753
                        ],
                        [
                            50.84941959369861,
                            4.337736864539849
                        ],
                        [
                            50.84953608518638,
                            4.337784643619738
                        ],
                        [
                            50.85022612048617,
                            4.338144684061152
                        ],
                        [
                            50.853337,
                            4.3410677
                        ],
                        [
                            50.85382905207529,
                            4.341723574858287
                        ],
                        [
                            50.854960324332474,
                            4.34340084241102
                        ],
                        [
                            50.85497169776642,
                            4.3434213157555295
                        ],
                        [
                            50.85546627035711,
                            4.345973485618398
                        ],
                        [
                            50.85558850999974,
                            4.346832499909527
                        ],
                        [
                            50.855590131992585,
                            4.3468592683952725
                        ],
                        [
                            50.855624783753875,
                            4.347612156320343
                        ],
                        [
                            50.85596404366305,
                            4.355331013524629
                        ],
                        [
                            50.855742331951184,
                            4.3584319084206165
                        ],
                        [
                            50.85519821563299,
                            4.360630401573842
                        ],
                        [
                            50.8551822,
                            4.3606829
                        ],
                        [
                            50.85517832683685,
                            4.360691843175768
                        ],
                        [
                            50.853724968952996,
                            4.363491286777144
                        ],
                        [
                            50.848855093268945,
                            4.368465066771852
                        ],
                        [
                            50.848850185756746,
                            4.368469054085438
                        ],
                        [
                            50.84857360920893,
                            4.368548431713563
                        ],
                        [
                            50.848174472411344,
                            4.368645055840708
                        ],
                        [
                            50.84713690160765,
                            4.368600690341413
                        ],
                        [
                            50.845625090563,
                            4.368186926532916
                        ],
                        [
                            50.84417484971202,
                            4.367609903729643
                        ],
                        [
                            50.84381666464587,
                            4.367376222670197
                        ],
                        [
                            50.83877176763051,
                            4.361963542951128
                        ],
                        [
                            50.838741077930266,
                            4.361858128542586
                        ],
                        [
                            50.83808138247235,
                            4.358385367873657
                        ],
                        [
                            50.83740308829726,
                            4.354569725679166
                        ],
                        [
                            50.837189643179116,
                            4.3532781066239465
                        ],
                        [
                            50.83701782130312,
                            4.350841933145205
                        ],
                        [
                            50.836954349382694,
                            4.347161857357477
                        ],
                        [
                            50.83718373712409,
                            4.345068181190975
                        ],
                        [
                            50.83718563665266,
                            4.345054592469728
                        ],
                        [
                            50.83746165456001,
                            4.343736194452256
                        ]
                    ]
                ]
            }
        },
        {
            "properties": {
                "time": 360
            },
            "type":"Feature",
            "geometry":{
                "type":"Polygon",
                "coordinates":[
                    [
                        [
                            50.83576162509021,
                            4.337882660556143
                        ],
                        [
                            50.838894007403965,
                            4.334967196062395
                        ],
                        [
                            50.839452169593564,
                            4.334534645136874
                        ],
                        [
                            50.84247112274082,
                            4.332485311464385
                        ],
                        [
                            50.8428833,
                            4.3323631
                        ],
                        [
                            50.84437642933302,
                            4.332042649728669
                        ],
                        [
                            50.84969049328092,
                            4.331937067196117
                        ],
                        [
                            50.851315941755104,
                            4.332804540474747
                        ],
                        [
                            50.8554194024129,
                            4.336311484162653
                        ],
                        [
                            50.856992484497816,
                            4.338976187431273
                        ],
                        [
                            50.857996533819204,
                            4.34103819679889
                        ],
                        [
                            50.85918181706143,
                            4.347261145546498
                        ],
                        [
                            50.85947299557107,
                            4.357251046451861
                        ],
                        [
                            50.85933127602453,
                            4.359878182722203
                        ],
                        [
                            50.858586140236326,
                            4.362883458817801
                        ],
                        [
                            50.85490500253779,
                            4.368181721445753
                        ],
                        [
                            50.85000539431162,
                            4.37385087913309
                        ],
                        [
                            50.84987167421365,
                            4.373998625613491
                        ],
                        [
                            50.849781589382836,
                            4.374096479859639
                        ],
                        [
                            50.84443583869694,
                            4.374134092485234
                        ],
                        [
                            50.84434669096947,
                            4.374098905841992
                        ],
                        [
                            50.84165059867055,
                            4.3727054541596235
                        ],
                        [
                            50.83530535420745,
                            4.363830867105582
                        ],
                        [
                            50.834413596611455,
                            4.3578910038736085
                        ],
                        [
                            50.83438705972786,
                            4.357501808790318
                        ],
                        [
                            50.83404934034713,
                            4.350334915720185
                        ],
                        [
                            50.83400734659396,
                            4.348733405637992
                        ],
                        [
                            50.83399701755228,
                            4.345691315767555
                        ],
                        [
                            50.833999813880155,
                            4.344161574409291
                        ],
                        [
                            50.83411802909567,
                            4.343228371029128
                        ],
                        [
                            50.83418026265385,
                            4.342887214135773
                        ],
                        [
                            50.834192269397946,
                            4.342822830559495
                        ],
                        [
                            50.835475533257,
                            4.338327203591836
                        ]
                    ]
                ]
            }
        },
        {
            "properties":{
                "time": 420
            },
            "type":"Feature",
            "geometry":{
                "type":"Polygon",
                "coordinates":[
                    [
                        [
                            50.832500307057074,
                            4.334973752978991
                        ],
                        [
                            50.8329068,
                            4.334278
                        ],
                        [
                            50.8371927,
                            4.3304847
                        ],
                        [
                            50.8408486,
                            4.3277721
                        ],
                        [
                            50.84310873245627,
                            4.327039099234422
                        ],
                        [
                            50.84918462341559,
                            4.326054500195247
                        ],
                        [
                            50.85288190343795,
                            4.328262702742599
                        ],
                        [
                            50.85308368681953,
                            4.328458132796454
                        ],
                        [
                            50.8537025,
                            4.3291337
                        ],
                        [
                            50.8593327,
                            4.3352858
                        ],
                        [
                            50.85984966153532,
                            4.336009558148094
                        ],
                        [
                            50.860069005329095,
                            4.336701762302125
                        ],
                        [
                            50.861849094045986,
                            4.344287164693007
                        ],
                        [
                            50.862344064580604,
                            4.349454865874831
                        ],
                        [
                            50.86241711763191,
                            4.350256063822952
                        ],
                        [
                            50.862756934668646,
                            4.3555543719851215
                        ],
                        [
                            50.862929615387756,
                            4.358712069936757
                        ],
                        [
                            50.862933139403324,
                            4.35878556029381
                        ],
                        [
                            50.86289782061544,
                            4.361692339402275
                        ],
                        [
                            50.86216827286236,
                            4.36369011980619
                        ],
                        [
                            50.86128546425562,
                            4.365402624555338
                        ],
                        [
                            50.85730927730468,
                            4.371512482758321
                        ],
                        [
                            50.851627899945726,
                            4.37897477438748
                        ],
                        [
                            50.850089154006845,
                            4.379797021728964
                        ],
                        [
                            50.84335955377403,
                            4.379783013686139
                        ],
                        [
                            50.8432712989572,
                            4.379745181105124
                        ],
                        [
                            50.84043179607745,
                            4.37831151742108
                        ],
                        [
                            50.834527139816046,
                            4.370427374286432
                        ],
                        [
                            50.83289147027068,
                            4.368167756557363
                        ],
                        [
                            50.83223822214198,
                            4.367041674655086
                        ],
                        [
                            50.83167355721709,
                            4.3638030169991175
                        ],
                        [
                            50.83121227762549,
                            4.358387002835203
                        ],
                        [
                            50.83073623252921,
                            4.3480043708363905
                        ],
                        [
                            50.83073386695189,
                            4.34795045497929
                        ],
                        [
                            50.830837597338785,
                            4.344221080996618
                        ],
                        [
                            50.83084222498953,
                            4.344099885220739
                        ],
                        [
                            50.8308445,
                            4.3440502
                        ],
                        [
                            50.830845515815156,
                            4.344033106899093
                        ],
                        [
                            50.83231695801247,
                            4.335786924208454
                        ],
                        [
                            50.83246738837475,
                            4.335036827741283
                        ]
                    ]
                ]
            }
        },
        {
            "properties":{
                "time": 480
            },
            "type":"Feature",
            "geometry":{
                "type":"Polygon",
                "coordinates":[
                    [
                        [
                            50.83942220670589,
                            4.383788621378092
                        ],
                        [
                            50.83146215238302,
                            4.374101348880699
                        ],
                        [
                            50.82915153569376,
                            4.370243222042689
                        ],
                        [
                            50.82825070619831,
                            4.365247450398195
                        ],
                        [
                            50.82725575584442,
                            4.355992120909027
                        ],
                        [
                            50.827245,
                            4.3551395
                        ],
                        [
                            50.82726316336825,
                            4.3530578582092065
                        ],
                        [
                            50.827532946447015,
                            4.342165614208882
                        ],
                        [
                            50.82934723526218,
                            4.332169271281571
                        ],
                        [
                            50.82980247061244,
                            4.33030171706521
                        ],
                        [
                            50.83126851287136,
                            4.328892548360595
                        ],
                        [
                            50.83141007915374,
                            4.328767880159635
                        ],
                        [
                            50.832420525600114,
                            4.327933315838894
                        ],
                        [
                            50.83549,
                            4.3258296
                        ],
                        [
                            50.8393211,
                            4.3233029
                        ],
                        [
                            50.8395251,
                            4.3232333
                        ],
                        [
                            50.8487455,
                            4.3209775
                        ],
                        [
                            50.848769,
                            4.3209743
                        ],
                        [
                            50.8488021,
                            4.320976
                        ],
                        [
                            50.8589669,
                            4.3279228
                        ],
                        [
                            50.8606918262105,
                            4.329238632241035
                        ],
                        [
                            50.86114619511231,
                            4.329667816975722
                        ],
                        [
                            50.862098423841616,
                            4.3314361320529535
                        ],
                        [
                            50.86225020871335,
                            4.331769028549044
                        ],
                        [
                            50.86266223858616,
                            4.332711516589257
                        ],
                        [
                            50.863009095767026,
                            4.333610795950577
                        ],
                        [
                            50.864744161698155,
                            4.339892766769811
                        ],
                        [
                            50.86648622631661,
                            4.360802005532454
                        ],
                        [
                            50.866493468073145,
                            4.3620763542354615
                        ],
                        [
                            50.86606238435144,
                            4.363606599884449
                        ],
                        [
                            50.86464830211199,
                            4.367379893858954
                        ],
                        [
                            50.86355770907078,
                            4.369760564425945
                        ],
                        [
                            50.86354365857022,
                            4.369785425724705
                        ],
                        [
                            50.86308701922637,
                            4.370581068950594
                        ],
                        [
                            50.85980919704022,
                            4.375536819451303
                        ],
                        [
                            50.858875772824696,
                            4.376947308387914
                        ],
                        [
                            50.851914053018646,
                            4.3848473709972
                        ],
                        [
                            50.85127077581525,
                            4.385122677298874
                        ],
                        [
                            50.85091551939496,
                            4.385152254202915
                        ],
                        [
                            50.84958846573396,
                            4.385192996511677
                        ],
                        [
                            50.84296419049574,
                            4.38524294033149
                        ],
                        [
                            50.842304928159585,
                            4.385213595069366
                        ],
                        [
                            50.842154411199026,
                            4.385189769968048
                        ],
                        [
                            50.842079002436826,
                            4.385166628131882
                        ],
                        [
                            50.83979199412863,
                            4.384048229492567
                        ]
                    ]
                ]
            }
        }
    ]
};

function area (lat, polygon) {
    const cos = Math.cos(lat * Math.PI / 180);
    const cos2 = 2 * cos * cos - 1;
    const cos3 = 2 * cos * cos2 - cos;
    const cos4 = 2 * cos * cos3 - cos2;
    const cos5 = 2 * cos * cos4 - cos3;

    // multipliers for converting longitude and latitude degrees into distance (http://1.usa.gov/1Wb1bv7)
    const kx = (111.41513 * cos - 0.09455 * cos3 + 0.00012 * cos5);
    const ky = (111.13209 - 0.56605 * cos2 + 0.0012 * cos4);

    let sum = 0;

    for (var i = 0; i < polygon.length; i++) {
        var ring = polygon[i];

        for (var j = 0, len = ring.length, k = len - 1; j < len; k = j++) {
            sum += (ring[j][0] - ring[k][0]) * (ring[j][1] + ring[k][1]) * (i ? -1 : 1);
        }
    }

    return (Math.abs(sum) / 2) * kx * ky;
}

// compute extra data for the visualisation
rawData.features = rawData.features.map(ft => {
    const modified = ft;
    const seconds = ft.properties.time;
    modified.properties.minutes = seconds/60;
    modified.properties.quantized = seconds % 600 === 0 ? 3600 : (seconds % 300 === 0 ? 1800 : (seconds % 300 === 0 ? 900 : 1));
    modified.properties.area = area(userPosition[1], modified.geometry.coordinates);
    return modified;
}).reverse();

map.on('load', function () {
    map.addSource('userDataset', {
        'type': 'geojson',
        'data': rawData
    })

    // layer for all isochrones
    .addLayer({
        'id': 'userlayer-quantized',
        'type': 'line',
        'source': 'userDataset',
        'layout':{
            'visibility': 'visible',
        },
        'paint':{
            'line-color': {
                'property': 'time',
                'type': 'interval',
                'stops': colorSchemes.altColor.map(function(pair){var edited = [pair[0]-300, pair[1]]; return edited})
            },
            'line-opacity': 0.25,
            'line-width': {
                base: 1.5,
                'stops': [[10,1],[22, 4]]
            },
        }
    })

    .addLayer({
        'id': 'userlayer-quantized-major',
        'type': 'line',
        'source': 'userDataset',
        'filter':['>=', 'quantized', options.threshold],
        'layout':{
            'visibility': 'visible',
        },
        'paint':{
            'line-color': {
                'property': 'time',
                'type': 'interval',
                'stops': colorSchemes.altColor
            },
            'line-width': {
                base: 1,
                'stops': [[10, 1.5],[22, 15]]
            }
        },
    })

    .addLayer({
        'id': 'userlayer-quantized-label',
        'type': 'symbol',
        'source': 'userDataset',
        'filter':['>=', 'quantized', options.threshold],
        'layout':{
            'visibility': 'visible',
            'text-field':'{minutes} MIN',
            'text-font': ['DIN Offc Pro Bold'],
            'symbol-placement': 'line',
            'text-allow-overlap': true,
            'text-padding':1,
            'text-max-angle':90,
            'text-size': {
                base: 1.2,
                'stops': [[8,12],[22, 30]]
            },
            'text-letter-spacing':0.1
        },
        'paint':{
            'text-halo-color': 'hsl(55, 1%, 20%)',
            'text-color': {
                'property': 'time',
                'type': 'interval',
                'stops': colorSchemes.altColor
            },
            'text-halo-width': 12,
        }
    });

    // fetch isochrones coordinates with mapbox-isochrone package,
    // calculate some properties for the quantized layers
    // and reload the "userDataset" source with the data
    isochrone(userPosition, options, (err, output) => {
        if (err) throw err;
        //map.getSource('userDataset').setData(rawData);

        const isochrones = output;
        isochrones.features = isochrones.features.map(ft => {
            var modified = ft;
            var seconds = ft.properties.time;
            modified.properties.minutes = seconds/60;
            modified.properties.quantized= seconds % 600 === 0 ? 3600 : (seconds % 300 === 0 ? 1800 : (seconds % 300 === 0 ? 900 : 1));
            modified.properties.area = ruler.area(modified.geometry.coordinates)
            return modified
        }).reverse();

        console.log("MapBox Data: ", isochrones);
        console.log("PlannerJS Data: ", rawData);
        //map.getSource('userDataset').setData(rawData);
        map.getSource('userDataset').setData(isochrones);
    });

    map.addImage('pulsing-dot', pulsingDot, { pixelRatio: 1 });

    map.addSource("bikestores", {
        "type": "geojson",
        "data": {
            "type": "FeatureCollection",
            "features": [{
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [4.347640, 50.857930]
                },
                "properties": {
                    "title": "Magic Vélos"
                }
            }, {
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [4.350970, 50.850651]
                },
                "properties": {
                    "title": "Decathlon"
                }
            }, {
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [4.346090, 50.852520]
                },
                "properties": {
                    "title": "CyCLO"
                }
            }, {
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [4.346240, 50.848280]
                },
                "properties": {
                    "title": "Velodroom"
                }
            }, {
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [4.346930, 50.846060]
                },
                "properties": {
                    "title": "VeloFixer"
                }
            }, {
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [4.355710, 50.845540]
                },
                "properties": {
                    "title": "Fietspunt"
                }
            }, {
                "type": "Feature",
                "geometry": {
                    "type": "Point",
                    "coordinates": [4.358070, 50.845490]
                },
                "properties": {
                    "title": "Ahooga Central Station"
                }
            }]
        }
    });

    map.addLayer({
        "id": "points",
        "type": "symbol",
        "source": "bikestores",
        "layout": {
            "icon-image": "pulsing-dot"
        }
    });
});

